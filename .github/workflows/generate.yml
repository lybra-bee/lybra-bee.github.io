name: ü§ñ Generate & Publish AI Post

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install deps
        run: |
          pip install --upgrade pip
          pip install groq requests pyyaml feedparser pillow

      - name: üßπ Clean old
        run: |
          find _posts -name "*.md" -mtime +50 -delete || true
          find assets/images/posts -name "*.jpg" -mtime +50 -delete || true

      - name: ü§ñ Generate
        run: python generate_post.py
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}
          STABILITYAI_KEY: ${{ secrets.STABILITYAI_KEY }}
          HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}

      - name: üíæ Commit
        run: |
          git config --global user.name 'lybra-bee'
          git config --global user.email 'lybra1167@gmail.com'
          git add .
          git commit -m "ü§ñ Daily AI $(date +%F)" || true
          git push

      - name: ‚è±Ô∏è Wait CDN
        run: |
          IMG=$(ls -t assets/images/posts/post-* | head -1 | xargs basename)
          URL="https://raw.githubusercontent.com/${{ github.repository }}/main/assets/images/posts/$IMG"
          for i in {1..30}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" "$URL")" = "200" ] && exit 0
            sleep 5
          done
