name: ü§ñ Generate & Publish AI Post

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install groq requests pyyaml feedparser matplotlib
      
      - name: üßπ Clean old files
        run: |
          find _posts -name "*.md" -mtime +50 -delete || true
          find assets/images/posts -name "*.png" -mtime +50 -delete || true
      
      - name: ü§ñ Generate AI content
        id: generator
        run: |
          python generate_post.py > generation.log 2>&1
          echo "title=$(grep '–ó–∞–≥–æ–ª–æ–≤–æ–∫:' generation.log | cut -d' ' -f2-)" >> $GITHUB_OUTPUT
          echo "trend=$(grep '–¢—Ä–µ–Ω–¥:' generation.log | cut -d' ' -f2-)" >> $GITHUB_OUTPUT
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}
      
      - name: ‚úÖ Validate generation
        run: |
          if [ ! -f "_posts/$(date +%Y-%m-%d)*.md" ]; then
            echo "‚ùå –ü–æ—Å—Ç –Ω–µ —Å–æ–∑–¥–∞–Ω"
            exit 1
          fi
          echo "‚úÖ –ü–æ—Å—Ç —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
      
      - name: üìä Upload logs (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
        if: always()
        uses: actions/upload-artifact@v4  # ‚Üê –ò–°–ü–†–ê–í–õ–ï–ù–û: v3 ‚Üí v4
        with:
          name: generation-log-${{ github.run_id }}
          path: generation.log
          retention-days: 7
      
      - name: üíæ Commit and push
        run: |
          git config --global user.name 'lybra-bee'
          git config --global user.email 'lybra1167@gmail.com'
          git add .
          git commit -m "ü§ñ Daily AI: $(date +%Y-%m-%d) - ${{ steps.generator.outputs.trend }}"
          git push
      
      - name: ‚è±Ô∏è Wait for GitHub CDN
        run: |
          POST_NUM=$(ls assets/images/posts/*.png | tail -1 | grep -o 'post-[0-9]*' | grep -o '[0-9]*')
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/assets/images/posts/post-${POST_NUM}.png"
          
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $IMAGE_URL"
          for i in {1..30}; do
            if curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL" | grep -q "200"; then
              echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ $i)"
              echo "image_url=$IMAGE_URL" >> $GITHUB_ENV
              exit 0
            fi
            echo "‚è≥ –ü–æ–ø—ã—Ç–∫–∞ $i/30..."
            sleep 10
          done
          echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É"
          echo "image_url=https://lybra-ai.ru/assets/images/default.png" >> $GITHUB_ENV
      
      - name: üì¢ Send to Telegram
        run: |
          python - << 'PYEOF'
          import os, re, requests
          from datetime import datetime

          # –î–∞–Ω–Ω—ã–µ
          title = "${{ steps.generator.outputs.title }}"
          image_url = os.getenv('image_url')
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–∏–∑–µ—Ä –∏–∑ –ø–æ—Å—Ç–∞
          post_file = "_posts/$(date +%Y-%m-%d)*.md"
          with open(os.path.expandvars(post_file), 'r', encoding='utf-8') as f:
              content = f.read().split('---')[-1]
              teaser = ' '.join(content.split()[:30]) + '‚Ä¶'

          # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2
          def esc(text):
              return re.sub(r'([_*\[\]\(\)~`>#+\-=|{}.!])', r'\\\1', text)

          message = f"*–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è*\n\n{esc(teaser)}\n\n[–ß–∏—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ](https://lybra-ai.ru)\n\n{esc('#–ò–ò #LybraAI')}"

          # –û—Ç–ø—Ä–∞–≤–∫–∞
          resp = requests.post(
              f"https://api.telegram.org/bot{os.getenv('TELEGRAM_BOT_TOKEN')}/sendPhoto",
              data={
                  "chat_id": os.getenv('TELEGRAM_CHAT_ID'),
                  "caption": message,
                  "parse_mode": "MarkdownV2"
              },
              files={"photo": requests.get(image_url).content}
          )
          print(f"‚úÖ Telegram: {resp.status_code}")
          PYEOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
