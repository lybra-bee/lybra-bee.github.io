# .github/workflows/daily-publish.yml
name: ü§ñ Generate & Publish AI Post

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    env:
      # –ø—Ä–æ–±—Ä–æ—Å —Å–µ–∫—Ä–µ—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ job, —á—Ç–æ–±—ã –≤—Å–µ —à–∞–≥–∏ –º–æ–≥–ª–∏ –∏—Ö –≤–∏–¥–µ—Ç—å
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
      SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
      CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}
      STABILITYAI_KEY: ${{ secrets.STABILITYAI_KEY }}
      HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install groq requests pyyaml feedparser matplotlib Pillow

      - name: üßπ Clean old files
        run: |
          find _posts -name "*.md" -mtime +50 -delete || true
          find assets/images/posts -name "*.png" -mtime +50 -delete || true

      - name: ü§ñ Generate AI content
        id: generator
        run: |
          set -euo pipefail

          # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é (–¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å generation.log –∏ —Ñ–∞–π–ª—ã)
          python generate_post.py

          # –ë–µ—Ä—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç—Ä–µ–Ω–¥ –∏–∑ –ª–æ–≥–æ–≤ ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–∞–∂–µ —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏
          TITLE=$(grep 'üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫:' generation.log 2>/dev/null | sed -E 's/.*üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫:[[:space:]]*//' | head -n1 || echo 'AI Article')
          TREND=$(grep '–¢—Ä–µ–Ω–¥:' generation.log 2>/dev/null | sed -E 's/.*–¢—Ä–µ–Ω–¥:[[:space:]]*//' | head -n1 || echo 'AI Trend')

          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º outputs –±–µ–∑–æ–ø–∞—Å–Ω–æ (heredoc) ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã
          echo "title<<EOF" >> $GITHUB_OUTPUT
          echo "$TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "trend<<EOF" >> $GITHUB_OUTPUT
          echo "$TREND" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

        # env –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –Ω–∞ —É—Ä–æ–≤–µ–Ω—å job ‚Äî –Ω–µ –æ–±—è–∑–∞–Ω—ã —Ç—É—Ç –ø–æ–≤—Ç–æ—Ä—è—Ç—å

      - name: üìä Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generation-log-${{ github.run_id }}
          path: generation.log
          retention-days: 7

      - name: üíæ Commit and push
        run: |
          git config --global user.name 'lybra-bee'
          git config --global user.email 'lybra1167@gmail.com'
          git add .
          git commit -m "ü§ñ Daily AI: $(date +%Y-%m-%d) - ${{ steps.generator.outputs.trend }}" || echo "No changes"
          git push

      - name: üóìÔ∏è Export post path
        run: |
          TODAY=$(date +%Y-%m-%d)
          POST_FILE=$(ls -t _posts/${TODAY}-*.md 2>/dev/null | head -n1)
          [ -z "$POST_FILE" ] && POST_FILE=$(ls -t _posts/*.md | head -n1)
          echo "POST_FILE=$POST_FILE" >> $GITHUB_ENV

      - name: ‚è±Ô∏è Wait for exact image CDN
        run: |
          set -euo pipefail
          # –ë–µ—Ä—ë–º —Ç–æ—á–Ω–æ–µ –∏–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (png)
          LATEST_IMG=$(ls -t assets/images/posts/post-*.png 2>/dev/null | head -n1 || true)
          if [ -z "$LATEST_IMG" ]; then
            echo "image_url=https://lybra-ai.ru/assets/images/default.png" >> $GITHUB_ENV
            echo "‚ö†Ô∏è –ù–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É"
            exit 0
          fi
          IMG_NAME=$(basename "$LATEST_IMG")
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/assets/images/posts/${IMG_NAME}"

          echo "‚è≥ –ñ–¥—ë–º CDN: $IMAGE_URL"
          for i in {1..60}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL" || echo "000")
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ $i)"
              echo "image_url=$IMAGE_URL" >> $GITHUB_ENV
              exit 0
            fi
            sleep 5
          done

          echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É"
          echo "image_url=https://lybra-ai.ru/assets/images/default.png" >> $GITHUB_ENV

      - name: üì¢ Send to Telegram
        if: always()
        run: |
          python - <<'PYCODE'
import os, re, requests, sys, time
from urllib.parse import urlparse

post_file = os.getenv("POST_FILE")
img_url = os.getenv("image_url")
bot_token = os.getenv("TELEGRAM_BOT_TOKEN")
chat_id = os.getenv("TELEGRAM_CHAT_ID")

def log(s): 
    print(s)

if not post_file or not os.path.exists(post_file):
    log("‚ö†Ô∏è –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º Telegram")
    sys.exit(0)
if not bot_token or not chat_id:
    log("‚ö†Ô∏è Telegram –∫–ª—é—á–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
    sys.exit(0)

with open(post_file, encoding='utf-8') as f:
    content = f.read().split('---')[-1].strip()
    teaser = ' '.join(content.split()[:30]) + '‚Ä¶'

def escape_md_v2(text):
    # –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã MarkdownV2
    return re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', text)

caption = f"*–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è*\n\n{escape_md_v2(teaser)}\n\n[–ß–∏—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ](https://lybra-ai.ru)\n\n{escape_md_v2('#–ò–ò #LybraAI')}"

# –ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
photo_bytes = None
if img_url:
    try:
        r = requests.get(img_url, timeout=20)
        if r.status_code == 200:
            photo_bytes = r.content
        else:
            log(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, HTTP {r.status_code}")
    except Exception as e:
        log(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {e}")

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º photo, –µ—Å–ª–∏ –µ—Å—Ç—å, –∏–Ω–∞—á–µ –ø–æ—Å—ã–ª–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é —Å—Å—ã–ª–∫—É
send_success = False
if photo_bytes:
    files = {
        "photo": ("post.png", photo_bytes, "image/png")
    }
    data = {
        "chat_id": chat_id,
        "caption": caption,
        "parse_mode": "MarkdownV2"
    }
    try:
        resp = requests.post(f"https://api.telegram.org/bot{bot_token}/sendPhoto", data=data, files=files, timeout=30)
        log(f"üì¢ Telegram (sendPhoto) status: {resp.status_code}")
        if resp.status_code == 200:
            send_success = True
    except Exception as e:
        log(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ sendPhoto: {e}")

if not send_success:
    # fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    try:
        msg = f"–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è\n\n{teaser}\n\n–ß–∏—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ: https://lybra-ai.ru\n\n–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: {img_url or 'none'}"
        resp = requests.post(f"https://api.telegram.org/bot{bot_token}/sendMessage", data={
            "chat_id": chat_id,
            "text": msg
        }, timeout=15)
        log(f"üì¢ Telegram (sendMessage) status: {resp.status_code}")
    except Exception as e:
        log(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ sendMessage: {e}")
PYCODE

        env:
          # job-level env already provides these, but we can be explicit here (optional)
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
