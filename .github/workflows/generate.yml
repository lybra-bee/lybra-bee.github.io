# .github/workflows/daily-publish.yml
name: ü§ñ Generate & Publish AI Post

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

permissions:
  contents: write

jobs:
  generate-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: üì¶ Install dependencies
        run: |
          pip install --upgrade pip
          pip install groq requests pyyaml feedparser matplotlib

      - name: üßπ Clean old files
        run: |
          find _posts -name "*.md" -mtime +50 -delete || true
          find assets/images/posts -name "*.png" -mtime +50 -delete || true

      - name: ü§ñ Generate AI content
        id: generator
        run: |
          python generate_post.py
          echo "title=$(grep '–ó–∞–≥–æ–ª–æ–≤–æ–∫:' generation.log 2>/dev/null | cut -d' ' -f2- || echo 'AI Article')" >> $GITHUB_OUTPUT
          echo "trend=$(grep '–¢—Ä–µ–Ω–¥:' generation.log 2>/dev/null | cut -d' ' -f2- || echo 'AI Trends')" >> $GITHUB_OUTPUT
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
          CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}

      - name: üìä Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generation-log-${{ github.run_id }}
          path: generation.log
          retention-days: 7

      - name: üíæ Commit and push
        run: |
          git config --global user.name 'lybra-bee'
          git config --global user.email 'lybra1167@gmail.com'
          git add .
          git commit -m "ü§ñ Daily AI: $(date +%Y-%m-%d) - ${{ steps.generator.outputs.trend }}" || echo "No changes"
          git push

      - name: üóìÔ∏è Export post path
        run: |
          TODAY=$(date +%Y-%m-%d)
          POST_FILE=$(ls -t _posts/${TODAY}-*.md 2>/dev/null | head -n1)
          [ -z "$POST_FILE" ] && POST_FILE=$(ls -t _posts/*.md | head -n1)
          echo "POST_FILE=$POST_FILE" >> $GITHUB_ENV

      - name: ‚è±Ô∏è Wait for exact image CDN
        run: |
          # –ë–µ—Ä—ë–º –Ω–æ–º–µ—Ä –∏–∑ —Å–≤–µ–∂–µ—Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ PNG (–ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
          PNG_NUM=$(ls -t assets/images/posts/post-*.png | head -1 | grep -o '[0-9]\+' | head -1)
          IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/assets/images/posts/post-${PNG_NUM}.png"

          echo "‚è≥ –ñ–¥—ë–º CDN: $IMAGE_URL"
          for i in {1..60}; do
            [ "$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")" = "200" ] && \
              echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ $i)" && \
              echo "image_url=$IMAGE_URL" >> $GITHUB_ENV && exit 0
            sleep 10
          done
          echo "‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É" && \
          echo "image_url=https://lybra-ai.ru/assets/images/default.png" >> $GITHUB_ENV

      - name: üì¢ Send to Telegram
        run: |
          python - << 'PYEOF'
          import os, re, requests
          from datetime import datetime

          title   = "${{ steps.generator.outputs.title }}"
          img_url = os.getenv('image_url')
          post_file = os.getenv('POST_FILE')

          if not post_file or not os.path.exists(post_file):
              print("‚ö†Ô∏è –ü–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º Telegram")
              exit(0)

          with open(post_file, encoding='utf-8') as f:
              content = f.read().split('---')[-1]
              teaser  = ' '.join(content.split()[:30]) + '‚Ä¶'

          def esc(text):
              return re.sub(r'([_*\[\]\(\)~`>#+\-=|{}.!])', r'\\\1', text)

          message = f"*–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è*\n\n{esc(teaser)}\n\n[–ß–∏—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ](https://lybra-ai.ru)\n\n{esc('#–ò–ò #LybraAI')}"

          resp = requests.post(
              f"https://api.telegram.org/bot{os.getenv('TELEGRAM_BOT_TOKEN')}/sendPhoto",
              data={"chat_id": os.getenv('TELEGRAM_CHAT_ID'),
                    "caption": message,
                    "parse_mode": "MarkdownV2"},
              files={"photo": requests.get(img_url).content}
          )
          print(f"‚úÖ Telegram: {resp.status_code}")
          PYEOF
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
