name: –¢–µ—Å—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –≤ Telegram

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  test_send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pyyaml
      - name: Extract last post data
        run: |
          python -c "
          import glob
          import yaml
          import os
          post_files = sorted(glob.glob('_posts/*.md'), reverse=True)
          if not post_files:
            print('No posts found')
            exit(1)
          with open(post_files[0], 'r', encoding='utf-8') as f:
            content = f.read()
          # –ü–∞—Ä—Å–∏–Ω–≥ YAML
          parts = content.split('---')
          if len(parts) < 3:
            print('Invalid post format')
            exit(1)
          front_matter = yaml.safe_load(parts[1])
          title = front_matter.get('title', 'Unknown Title')
          date = front_matter.get('date', '').split(' ')[0].replace('-', '/')
          slug = post_files[0].split('/')[-1].replace('.md', '').split('-', 3)[-1]
          post_num = front_matter.get('image', '').split('-')[-1].replace('.png', '')
          body = parts[2].strip()
          teaser = ' '.join(body.split()[:100]).strip() + '...' if len(body.split()) > 100 else body
          os.environ['TITLE'] = title
          os.environ['DATE'] = date
          os.environ['SLUG'] = slug
          os.environ['POST_NUM'] = str(post_num)
          os.environ['TEASER'] = teaser
          print(f'Title: {title}, Date: {date}, Slug: {slug}, Post Num: {post_num}')
          "
      - name: Send to Telegram
        uses: appleboy/telegram-action@v0.1.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          message: |
            üì¢ –¢–µ—Å—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞: "${{ env.TITLE }}"

            –¢–∏–∑–µ—Ä: ${{ env.TEASER }}

            –ß–∏—Ç–∞—Ç—å: https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}?utm_source=telegram&utm_medium=channel&utm_campaign=test

            #–ò–ò #–¢—Ä–µ–Ω–¥—ã2025 #LybraAI
          photo: https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png
      - name: Log Telegram step
        run: |
          echo "TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}"
          echo "Post title: ${{ env.TITLE }}"
          echo "Teaser: ${{ env.TEASER }}"
          echo "URL: https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}"
