name: Generate and Deploy Hugo Site

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 6:00 UTC

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-slugify pyyaml

    - name: Create necessary directories
      run: |
        mkdir -p content/posts
        mkdir -p static/images/posts
        mkdir -p data
        mkdir -p layouts/partials

    - name: Create basic config.toml
      run: |
        cat > config.toml << 'EOF'
        baseURL = "https://${{ github.repository_owner }}.github.io/"
        languageCode = "ru-ru"
        title = "AI –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ"

        [params]
        description = "–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö AI —Å—Ç–∞—Ç–µ–π –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"

        [menu]
          [[menu.main]]
            name = "–ì–ª–∞–≤–Ω–∞—è"
            url = "/"
            weight = 1

          [[menu.main]]
            name = "–°—Ç–∞—Ç—å–∏"
            url = "/articles/"
            weight = 2

          [[menu.main]]
            name = "–ì–∞–ª–µ—Ä–µ—è"
            url = "/gallery/"
            weight = 3

          [[menu.main]]
            name = "–û–±–æ –º–Ω–µ"
            url = "/about/"
            weight = 4
        EOF

    - name: Create layout files
      run: |
        # –°–æ–∑–¥–∞–µ–º partials –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        mkdir -p layouts/partials

        # Header partial
        cat > layouts/partials/header.html << 'EOF'
        <nav class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="text-xl font-bold text-gray-800">
                        <a href="/">üé® AI –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</a>
                    </div>
                    <div class="hidden md:flex space-x-8">
                        {{ range .Site.Menus.main }}
                        <a href="{{ .URL }}" class="text-gray-700 hover:text-blue-600 transition">{{ .Name }}</a>
                        {{ end }}
                    </div>
                </div>
            </div>
        </nav>
        EOF

        # Footer partial
        cat > layouts/partials/footer.html << 'EOF'
        <footer class="bg-gray-800 text-white py-12">
            <div class="max-w-7xl mx-auto px-4 text-center">
                <p class="text-lg mb-4">üé® AI –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</p>
                <p class="text-gray-400">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –ø–æ–º–æ—â—å—é AI —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π</p>
                <div class="mt-6">
                    <p class="text-sm text-gray-500">¬© 2024 –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã</p>
                </div>
            </div>
        </footer>
        EOF

        # Main layout
        cat > layouts/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="ru">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>{{ .Site.Title }}</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.css" rel="stylesheet">
        </head>
        <body class="bg-gray-50 min-h-screen">
            {{ partial "header.html" . }}

            <!-- Hero Section -->
            <section class="bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 text-white py-20">
                <div class="max-w-4xl mx-auto text-center px-4">
                    <h1 class="text-4xl md:text-6xl font-bold mb-6">ü§ñ AI –ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</h1>
                    <p class="text-xl md:text-2xl mb-8">–°—Ç–∞—Ç—å–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</p>
                    <div class="flex justify-center space-x-4">
                        <a href="#latest-article" class="bg-white text-blue-600 px-8 py-3 rounded-lg font-semibold hover:bg-gray-100 transition">
                            üìñ –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞—Ç—å—è
                        </a>
                        <a href="/gallery/" class="border-2 border-white text-white px-8 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition">
                            üé® –ì–∞–ª–µ—Ä–µ—è
                        </a>
                    </div>
                </div>
            </section>

            <!-- Latest Article -->
            <section id="latest-article" class="py-16">
                <div class="max-w-6xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-center mb-12">üìù –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞—Ç—å—è</h2>
                    {{ $latest := (where .Site.RegularPages "Type" "posts" | first 1) }}
                    {{ range $latest }}
                    <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                        <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-full h-64 object-cover">
                        <div class="p-8">
                            <div class="flex items-center mb-4">
                                <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                                    {{ .Date.Format "2006-01-02" }}
                                </span>
                            </div>
                            <h3 class="text-2xl font-bold mb-4">{{ .Title }}</h3>
                            <p class="text-gray-600 mb-6 leading-relaxed">{{ .Description }}</p>
                            <div class="flex items-center justify-between">
                                <div class="flex space-x-2">
                                    {{ range .Params.tags }}
                                    <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">
                                        {{ . }}
                                    </span>
                                    {{ end }}
                                </div>
                                <a href="{{ .Permalink }}" class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition">
                                    –ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é ‚Üí
                                </a>
                            </div>
                        </div>
                    </div>
                    {{ end }}
                </div>
            </section>

            <!-- Articles Preview -->
            <section class="py-16 bg-gray-100">
                <div class="max-w-7xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-center mb-12">üìö –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç–∞—Ç—å–∏</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        {{ $articles := (where .Site.RegularPages "Type" "posts" | after 1 | first 3) }}
                        {{ range $articles }}
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-full h-48 object-cover">
                            <div class="p-6">
                                <h3 class="text-lg font-bold mb-2">{{ .Title }}</h3>
                                <p class="text-sm text-gray-600 mb-4">{{ .Description | truncate 100 }}</p>
                                <div class="flex items-center justify-between">
                                    <span class="text-xs text-gray-500">{{ .Date.Format "2006-01-02" }}</span>
                                    <a href="{{ .Permalink }}" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                        –ß–∏—Ç–∞—Ç—å ‚Üí
                                    </a>
                                </div>
                            </div>
                        </div>
                        {{ end }}
                    </div>
                    <div class="text-center mt-8">
                        <a href="/articles/" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition">
                            –í—Å–µ —Å—Ç–∞—Ç—å–∏
                        </a>
                    </div>
                </div>
            </section>

            <!-- Gallery Preview -->
            <section class="py-16">
                <div class="max-w-7xl mx-auto px-4">
                    <h2 class="text-3xl font-bold text-center mb-12">üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {{ $gallery := where .Site.Data.gallery "" "" | first 3 }}
                        {{ range $gallery }}
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                            <img src="{{ .src }}" alt="{{ .alt }}" class="w-full h-64 object-cover">
                            <div class="p-4">
                                <h3 class="font-semibold mb-2">{{ .title | truncate 50 }}</h3>
                                <p class="text-sm text-gray-600">{{ .date }}</p>
                            </div>
                        </div>
                        {{ end }}
                    </div>
                    <div class="text-center mt-8">
                        <a href="/gallery/" class="bg-gray-800 text-white px-8 py-3 rounded-lg hover:bg-gray-900 transition">
                            –í—Å—è –≥–∞–ª–µ—Ä–µ—è
                        </a>
                    </div>
                </div>
            </section>

            <!-- About Preview -->
            <section class="py-16 bg-gray-100">
                <div class="max-w-4xl mx-auto px-4 text-center">
                    <h2 class="text-3xl font-bold mb-8">üëã –û–±–æ –º–Ω–µ</h2>
                    <p class="text-xl text-gray-700 mb-8">
                        –Ø - AI —ç–Ω—Ç—É–∑–∏–∞—Å—Ç, —Å–æ–∑–¥–∞—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø–æ–º–æ—â—å—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. 
                        –ú–æ–∏ —Ä–∞–±–æ—Ç—ã –≤–∫–ª—é—á–∞—é—Ç —Å—Ç–∞—Ç—å–∏ –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º–∏.
                    </p>
                    <a href="/about/" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition">
                        –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
                    </a>
                </div>
            </section>

            {{ partial "footer.html" . }}

            <script src="https://cdn.jsdelivr.net/npm/swiper@8/swiper-bundle.min.js"></script>
        </body>
        </html>
        EOF

        # Create content pages
        mkdir -p content

        # About page
        cat > content/about.md << 'EOF'
        ---
        title: "–û–±–æ –º–Ω–µ"
        date: 2024-01-01
        draft: false
        ---

        ## üëã –ü—Ä–∏–≤–µ—Ç! –Ø AI —ç–Ω—Ç—É–∑–∏–∞—Å—Ç

        –Ø —Å–æ–∑–¥–∞—é –∫–æ–Ω—Ç–µ–Ω—Ç —Å –ø–æ–º–æ—â—å—é —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.

        ### üöÄ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏:

        - **GPT-4** –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–∞—Ç–µ–π
        - **Stable Diffusion** –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π  
        - **Hugo** –¥–ª—è —Å–∞–π—Ç–∞
        - **GitHub Actions** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

        ### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:

        - üìù –°—Ç–∞—Ç–µ–π: {{ len (where .Site.RegularPages "Type" "posts") }}
        - üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: {{ len .Site.Data.gallery }}

        *–°–∞–π—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º.*
        EOF

        # Articles list page
        cat > content/articles.md << 'EOF'
        ---
        title: "–í—Å–µ —Å—Ç–∞—Ç—å–∏"
        type: "articles"
        ---

        ## üìö –í—Å–µ —Å—Ç–∞—Ç—å–∏

        –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ AI —Å—Ç–∞—Ç—å–∏.
        EOF

        # Gallery page
        cat > content/gallery.md << 'EOF'
        ---
        title: "–ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"
        type: "gallery"
        ---

        ## üñºÔ∏è –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

        –ö–æ–ª–ª–µ–∫—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º.
        EOF

    - name: Generate article and image
      run: python .github/scripts/generate_content.py
      env:
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}

    - name: Commit generated content to main
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add content/posts/ static/images/posts/ data/gallery.yaml config.toml layouts/ content/about.md content/articles.md content/gallery.md
        git commit -m "ü§ñ Auto-generated content [CI]" || echo "No changes to commit"
        git push

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.120.4'
        extended: true

    - name: Build Hugo site
      run: hugo --minify --logLevel info

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./public
        force_orphan: true
        keep_files: false
        enable_jekyll: false
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
