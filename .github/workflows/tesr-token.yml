name: Test API Tokens

on:
  workflow_dispatch:  # ÐŸÐ¾Ð·Ð²Ð¾Ð»ÑÐµÑ‚ Ð·Ð°Ð¿ÑƒÑÐºÐ°Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-tokens:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pillow

    - name: Create test script
      run: |
        cat > test_tokens.py << 'EOF'
        #!/usr/bin/env python3
        import os
        import requests
        import logging

        # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        logging.basicConfig(
            level=logging.INFO,
            format='%(asctime)s - %(levelname)s - %(message)s',
            datefmt='%Y-%m-%d %H:%M:%S'
        )
        logger = logging.getLogger(__name__)

        def test_huggingface_token():
            """Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Hugging Face Ñ‚Ð¾ÐºÐµÐ½Ð°"""
            HF_TOKEN = os.getenv('HF_API_TOKEN')
            if not HF_TOKEN:
                logger.error("âŒ HF_API_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½")
                return False
            
            logger.info("ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Hugging Face Ñ‚Ð¾ÐºÐµÐ½...")
            
            try:
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                response = requests.get(
                    "https://huggingface.co/api/whoami",
                    headers={"Authorization": f"Bearer {HF_TOKEN}"},
                    timeout=10
                )
                
                if response.status_code == 200:
                    user_info = response.json()
                    logger.info(f"âœ… HF Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½! ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ: {user_info.get('name', 'Unknown')}")
                    
                    # Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Inference API
                    try:
                        test_response = requests.head(
                            "https://api-inference.huggingface.co/models/gpt2",
                            headers={"Authorization": f"Bearer {HF_TOKEN}"},
                            timeout=10
                        )
                        if test_response.status_code in [200, 403, 503]:
                            logger.info("âœ… Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Inference API ÐµÑÑ‚ÑŒ")
                        return True
                    except:
                        logger.info("â„¹ï¸  Inference API Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð° (Ñ‚Ð°Ð¹Ð¼Ð°ÑƒÑ‚)")
                        return True
                        
                else:
                    logger.error(f"âŒ HF Ñ‚Ð¾ÐºÐµÐ½ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½: {response.status_code}")
                    return False
                    
            except Exception as e:
                logger.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ HF: {e}")
                return False

        def test_replicate_token():
            """Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Replicate Ñ‚Ð¾ÐºÐµÐ½Ð°"""
            REPLICATE_TOKEN = os.getenv('REPLICATE_API_TOKEN')
            if not REPLICATE_TOKEN:
                logger.error("âŒ REPLICATE_API_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½")
                return False
            
            logger.info("ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Replicate Ñ‚Ð¾ÐºÐµÐ½...")
            
            try:
                # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð°ÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                response = requests.get(
                    "https://api.replicate.com/v1/models",
                    headers={"Authorization": f"Token {REPLICATE_TOKEN}"},
                    timeout=10
                )
                
                if response.status_code == 200:
                    models = response.json()
                    logger.info(f"âœ… Replicate Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½! Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹: {len(models.get('results', []))}")
                    return True
                else:
                    logger.error(f"âŒ Replicate Ñ‚Ð¾ÐºÐµÐ½ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½: {response.status_code}")
                    return False
                    
            except Exception as e:
                logger.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Replicate: {e}")
                return False

        def test_groq_token():
            """Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Groq Ñ‚Ð¾ÐºÐµÐ½Ð°"""
            GROQ_TOKEN = os.getenv('GROQ_API_KEY')
            if not GROQ_TOKEN:
                logger.error("âŒ GROQ_API_KEY Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½")
                return False
            
            logger.info("ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Groq Ñ‚Ð¾ÐºÐµÐ½...")
            
            try:
                response = requests.get(
                    "https://api.groq.com/openai/v1/models",
                    headers={"Authorization": f"Bearer {GROQ_TOKEN}"},
                    timeout=10
                )
                
                if response.status_code == 200:
                    models = response.json()
                    available_models = [model['id'] for model in models.get('data', [])[:2]]
                    logger.info(f"âœ… Groq Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½! ÐœÐ¾Ð´ÐµÐ»Ð¸: {', '.join(available_models)}")
                    return True
                else:
                    logger.error(f"âŒ Groq Ñ‚Ð¾ÐºÐµÐ½ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½: {response.status_code}")
                    return False
                    
            except Exception as e:
                logger.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Groq: {e}")
                return False

        def test_openrouter_token():
            """Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ OpenRouter Ñ‚Ð¾ÐºÐµÐ½Ð°"""
            OPENROUTER_TOKEN = os.getenv('OPENROUTER_API_KEY')
            if not OPENROUTER_TOKEN:
                logger.error("âŒ OPENROUTER_API_KEY Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½")
                return False
            
            logger.info("ðŸ§ª Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ OpenRouter Ñ‚Ð¾ÐºÐµÐ½...")
            
            try:
                response = requests.get(
                    "https://openrouter.ai/api/v1/auth/key",
                    headers={"Authorization": f"Bearer {OPENROUTER_TOKEN}"},
                    timeout=10
                )
                
                if response.status_code == 200:
                    key_info = response.json()
                    logger.info(f"âœ… OpenRouter Ñ‚Ð¾ÐºÐµÐ½ Ð²Ð°Ð»Ð¸Ð´ÐµÐ½! Ð›Ð¸Ð¼Ð¸Ñ‚Ñ‹: {key_info.get('data', {}).get('usage', {})}")
                    return True
                else:
                    logger.error(f"âŒ OpenRouter Ñ‚Ð¾ÐºÐµÐ½ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½: {response.status_code}")
                    return False
                    
            except Exception as e:
                logger.error(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ OpenRouter: {e}")
                return False

        def test_all_tokens():
            """Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð²"""
            print("=" * 60)
            print("ðŸ” Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð• Ð¢ÐžÐšÐ•ÐÐžÐ’ API")
            print("=" * 60)
            
            results = {}
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°ÐºÐ¸Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹
            tokens = {
                'HF_API_TOKEN': os.getenv('HF_API_TOKEN'),
                'REPLICATE_API_TOKEN': os.getenv('REPLICATE_API_TOKEN'),
                'GROQ_API_KEY': os.getenv('GROQ_API_KEY'),
                'OPENROUTER_API_KEY': os.getenv('OPENROUTER_API_KEY')
            }
            
            print("ðŸ“‹ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ñ‚Ð¾ÐºÐµÐ½Ñ‹:")
            for token_name, token_value in tokens.items():
                status = "âœ… ÐŸÐ Ð˜Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð•Ð¢" if token_value else "âŒ ÐžÐ¢Ð¡Ð£Ð¢Ð¡Ð¢Ð’Ð£Ð•Ð¢"
                masked_value = "set" if token_value else "not set"
                print(f"   {token_name}: {status} ({masked_value})")
            
            print("\n" + "=" * 60)
            
            # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ñ‚Ð¾ÐºÐµÐ½
            results['huggingface'] = test_huggingface_token()
            print()
            results['replicate'] = test_replicate_token()
            print()
            results['groq'] = test_groq_token()
            print()
            results['openrouter'] = test_openrouter_token()
            
            print("=" * 60)
            print("ðŸ“Š Ð Ð•Ð—Ð£Ð›Ð¬Ð¢ÐÐ¢Ð« Ð¢Ð•Ð¡Ð¢Ð˜Ð ÐžÐ’ÐÐÐ˜Ð¯:")
            print("=" * 60)
            
            all_working = True
            for service, success in results.items():
                status = "âœ… Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢" if success else "âŒ ÐÐ• Ð ÐÐ‘ÐžÐ¢ÐÐ•Ð¢"
                if not success:
                    all_working = False
                print(f"   {service.upper():<15}: {status}")
            
            print("=" * 60)
            
            # Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ¾Ð´ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹
            if not all_working:
                exit(1)

        if __name__ == "__main__":
            test_all_tokens()
        EOF

    - name: Run token tests
      env:
        HF_API_TOKEN: ${{ secrets.HF_API_TOKEN }}
        REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      run: python test_tokens.py

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: token-test-results
        path: |
          test_tokens.py
