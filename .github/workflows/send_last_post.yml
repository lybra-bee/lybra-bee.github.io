name: –û—Ç–ø—Ä–∞–≤–∫–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞

on:
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ workflow
  schedule:
    - cron: '0 0 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 00:00 UTC

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install groq requests pyyaml
          python -c "import groq, requests, yaml; print('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', groq.__version__, requests.__version__, yaml.__version__)"
      - name: Test network
        run: |
          ping -c 4 clipdrop-api.co || echo "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Clipdrop API"
      - name: Run generate_post.py
        run: |
          export PYTHONUNBUFFERED=1
          python generate_post.py
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          CLIPDROP_API_KEY: ${{ secrets.CLIPDROP_API_KEY }}
      - name: Commit changes
        run: |
          git config --global user.name 'lybra-bee'
          git config --global user.email 'lybra1167@gmail.com'
          git add .
          git commit -m "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–∞ –æ—Ç $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          git push

  send_to_telegram:
    runs-on: ubuntu-latest
    needs: generate
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
          python -c "import requests, yaml; print('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', requests.__version__, yaml.__version__)"

      - name: Send to Telegram
        run: |
          # –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏–∑ GitHub Actions
          POST_DATE=${{ env.DATE }}
          POST_SLUG=${{ env.SLUG }}
          POST_IMAGE="https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png"
          
          # –¢–∏–∑–µ—Ä: —á–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–µ 30 —Å–ª–æ–≤ –∏–∑ —Å—Ç–∞—Ç—å–∏
          TEASER=$(head -n 30 "${{ github.workspace }}/_posts/${POST_DATE}-${POST_SLUG}.md" | tail -n 1)

          # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram
          MESSAGE="üì¢ –ù–æ–≤—ã–π –ø–æ—Å—Ç: \"${{ env.TITLE }}\"

          –ö—Ä–∞—Ç–∫–∏–π —Ç–∏–∑–µ—Ä: ${TEASER}

          –ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é: https://lybra-ai.ru/${POST_DATE}/${POST_SLUG}

          #–ò–ò #–¢—Ä–µ–Ω–¥—ã2025 #LybraAI"
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"

          # –û—Ç–ø—Ä–∞–≤–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "photo=${POST_IMAGE}" \
            -d "caption=${MESSAGE}"
