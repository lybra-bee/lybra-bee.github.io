name: üì¢ Publish Last Post to Telegram

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "_posts/**"

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: üì¶ Install dependencies
        run: |
          pip install PyYAML requests

      - name: üöÄ Extract Last Post and Send to Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          import os, glob, yaml, re, requests

          # –ù–∞—Ö–æ–¥–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Å—Ç
          posts = sorted(glob.glob('_posts/*.md'), reverse=True)
          if not posts:
              raise SystemExit("‚ùå –ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –≤ _posts/")
          last_post = posts[0]

          with open(last_post, encoding='utf-8') as f:
              content = f.read()

          # Front-matter
          front_matter = re.search(r'^---(.*?)---', content, re.S)
          meta = yaml.safe_load(front_matter.group(1)) if front_matter else {}

          # –ö–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑ front-matter
          body = content.split('---')[-1].strip()

          # –¢–∏–∑–µ—Ä: –ø–µ—Ä–≤—ã–µ 30 —Å–ª–æ–≤
          words = body.split()
          teaser = ' '.join(words[:30]) + ('‚Ä¶' if len(words) > 30 else '')

          # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2
          def esc(text):
              return re.sub(r'([_*\[\]()~`>#+\-=|{}.!])', r'\\\1', text)

          teaser_esc = esc(teaser)
          hashtags_esc = esc("#–ò–ò #LybraAI")

          # –ö–∞—Ä—Ç–∏–Ω–∫–∞
          image_name = os.path.basename(meta.get('image', 'post-1.png'))
          image_url = f"https://lybra-bee.github.io/assets/images/posts/{image_name}"

          # URL –ø–æ—Å—Ç–∞
          date = str(meta.get('date', ''))
          slug = os.path.splitext(os.path.basename(last_post))[0].split('-', 3)[-1]
          url = f"https://lybra-bee.github.io/{date[:10].replace('-', '/')}/{slug}.html"

          # –°–æ–æ–±—â–µ–Ω–∏–µ
          message = f"*–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è*\n\n{teaser_esc}\n\n[–ß–∏—Ç–∞—Ç—å –Ω–∞ —Å–∞–π—Ç–µ]({url})\n\n{hashtags_esc}"

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ–∫–µ–Ω–∞ –∏ —á–∞—Ç–∞
          token = os.getenv('TELEGRAM_BOT_TOKEN')
          chat_id = os.getenv('TELEGRAM_CHAT_ID')
          if not token or not chat_id:
              raise SystemExit("‚ùå –ù–µ—Ç TELEGRAM_BOT_TOKEN –∏–ª–∏ TELEGRAM_CHAT_ID")

          # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ —Å –ø–æ–¥–ø–∏—Å—å—é
          resp = requests.post(
              f"https://api.telegram.org/bot{token}/sendPhoto",
              data={
                  "chat_id": chat_id,
                  "photo": image_url,
                  "caption": message,
                  "parse_mode": "MarkdownV2"
              }
          )

          print(f"‚úÖ Telegram –æ—Ç–≤–µ—Ç: {resp.status_code} ‚Äî {resp.text[:200]}")
        shell: python
