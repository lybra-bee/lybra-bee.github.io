name: Send Last Post to Telegram

on:
  workflow_run:
    workflows: ["–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ –ø–æ—Å—Ç–∞"]
    types:
      - completed

jobs:
  send_to_telegram:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
          python -c "import requests, yaml; print('–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', requests.__version__, yaml.__version__)"

      - name: Send to Telegram
        run: |
          export POST_DATE=${{ env.DATE }}
          export POST_SLUG=${{ env.SLUG }}
          export POST_IMAGE="https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png"
          
          MESSAGE="üì¢ –ù–æ–≤—ã–π –ø–æ—Å—Ç: \"${{ env.TITLE }}\"

          –ö—Ä–∞—Ç–∫–∏–π —Ç–∏–∑–µ—Ä: $(head -n 30 "${{ github.workspace }}/_posts/${POST_DATE}-${POST_SLUG}.md" | tail -n 1)

          –ß–∏—Ç–∞—Ç—å —Å—Ç–∞—Ç—å—é: https://lybra-ai.ru/${POST_DATE}/${POST_SLUG}

          #–ò–ò #–¢—Ä–µ–Ω–¥—ã2025 #LybraAI"
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=${MESSAGE}" \
            -d "parse_mode=Markdown"
