name: üì¢ Publish Post and Send Telegram

on:
  push:
    branches:
      - main

jobs:
  publish:
    name: üöÄ Publish and Notify
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 3Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å requirements.txt)
      - name: üì¶ Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      # 4Ô∏è‚É£ –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
      - name: üìù Extract post data
        id: extract
        run: |
          TITLE=$(git log -1 --pretty=%s)
          TEASER=$(git log -1 --pretty=%b | head -n 1)
          DATE=$(date +'%Y-%m-%d')
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | tr -dc 'a-z0-9-')
          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "TEASER=$TEASER" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "SLUG=$SLUG" >> $GITHUB_ENV
          echo "‚úÖ Extracted TITLE='$TITLE' SLUG='$SLUG'"

      # 5Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º Python-—Å–∫—Ä–∏–ø—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è Markdown –∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è
      - name: üß† Escape Markdown for Telegram
        id: escape
        run: |
          python3 escape_markdown.py
        env:
          GITHUB_ENV: ${{ env.GITHUB_ENV }}
          TITLE: ${{ env.TITLE }}
          TEASER: ${{ env.TEASER }}
          DATE: ${{ env.DATE }}
          SLUG: ${{ env.SLUG }}

      # 6Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
      - name: üì¨ Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: ${{ env.MESSAGE }}

      # 7Ô∏è‚É£ –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
      - name: üßæ Debug info
        if: always()
        run: |
          echo "TITLE: $TITLE"
          echo "TEASER: $TEASER"
          echo "DATE: $DATE"
          echo "SLUG: $SLUG"
          echo "MESSAGE:"
          echo "$MESSAGE"
