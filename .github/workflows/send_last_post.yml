name: ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¿Ð¾ÑÑ‚Ð° Ð² Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'  # Ð•Ð¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ Ð² 8:00 UTC (11:00 ÐœÐ¡Ðš)

env:
  ACTIONS_STEP_DEBUG: true  # Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¾Ñ‚Ð»Ð°Ð´ÐºÑƒ Ð´Ð»Ñ Ð²ÑÐµÑ… ÑˆÐ°Ð³Ð¾Ð²

jobs:
  send_post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml transliterate
      - name: Check post files
        run: |
          ls -l _posts/ || echo "No posts directory found"
          if [ -z "$(ls -A _posts/)" ]; then
            echo "::error::No Markdown files found in _posts/"
            exit 1
          fi
      - name: Check extract_post_data.py
        run: |
          ls -l extract_post_data.py || echo "::error::extract_post_data.py not found"
          if [ ! -f extract_post_data.py ]; then
            exit 1
          fi
      - name: Extract last post data
        run: |
          python extract_post_data.py
      - name: Validate extracted data
        run: |
          if [ -z "$TITLE" ]; then
            echo "::error::TITLE is empty"
            exit 1
          fi
          if [ -z "$DATE" ]; then
            echo "::error::DATE is empty"
            exit 1
          fi
          if [ -z "$SLUG" ]; then
            echo "::error::SLUG is empty"
            exit 1
          fi
          if [ -z "$POST_NUM" ]; then
            echo "::error::POST_NUM is empty, check front-matter 'image' in post"
            exit 1
          fi
      - name: Check image file
        run: |
          IMAGE_PATH="assets/images/posts/post-$POST_NUM.png"
          ls -l $IMAGE_PATH || echo "Image file $IMAGE_PATH not found in repository"
          if [ -f "$IMAGE_PATH" ]; then
            echo "IMAGE_FOUND=true" >> $GITHUB_ENV
          else
            echo "IMAGE_FOUND=false" >> $GITHUB_ENV
          fi
      - name: Check image URL
        run: |
          IMAGE_URL="https://lybra-ai.ru/assets/images/posts/post-$POST_NUM.png"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
          echo "Image URL $IMAGE_URL status: HTTP $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "IMAGE_URL_ACCESSIBLE=true" >> $GITHUB_ENV
            echo "PHOTO_URL=$IMAGE_URL" >> $GITHUB_ENV
          else
            echo "IMAGE_URL_ACCESSIBLE=false" >> $GITHUB_ENV
            echo "PHOTO_URL=https://lybra-ai.ru/assets/images/default.png" >> $GITHUB_ENV
            DEFAULT_HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://lybra-ai.ru/assets/images/default.png")
            echo "Default image status: HTTP $DEFAULT_HTTP_STATUS"
            if [ "$DEFAULT_HTTP_STATUS" != "200" ]; then
              echo "PHOTO_URL=" >> $GITHUB_ENV
              echo "::warning::Default image not accessible, skipping photo"
            fi
          fi
      - name: Prepare Telegram message
        run: |
          # Ð­ÐºÑ€Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð²ÑÐµÑ… ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð² Ð´Ð»Ñ MarkdownV2
          TITLE_ESCAPED=$(echo "$TITLE" | sed 's/[_*[\]()~`>#+-=|{}\.!-]/\\&/g')
          echo "TITLE_ESCAPED=$TITLE_ESCAPED" >> $GITHUB_ENV
          TEASER="${TEASER}"
          if [ -z "$TEASER" ]; then
            echo "TEASER is empty, setting default"
            TEASER="Ð§Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑ‚Ð°Ñ‚ÑŒÑŽ Ð¾ Ñ‚Ñ€ÐµÐ½Ð´Ð°Ñ… Ð˜Ð˜ 2025 Ð³Ð¾Ð´Ð° Ð½Ð° Ð½Ð°ÑˆÐµÐ¼ ÑÐ°Ð¹Ñ‚Ðµ!"
          fi
          TEASER=$(echo "$TEASER" | head -c 200)
          TEASER_ESCAPED=$(echo "$TEASER" | sed 's/[_*[\]()~`>#+-=|{}\.!-]/\\&/g')
          echo "TEASER_ESCAPED=$TEASER_ESCAPED" >> $GITHUB_ENV
          MESSAGE="ðŸ“¢ *ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ð¾ÑÑ‚*: \"$TITLE_ESCAPED\"\n\n*ÐšÑ€Ð°Ñ‚ÐºÐ¸Ð¹ Ñ‚Ð¸Ð·ÐµÑ€*: $TEASER_ESCAPED\n\n[Ð§Ð¸Ñ‚Ð°Ñ‚ÑŒ Ð½Ð° ÑÐ°Ð¹Ñ‚Ðµ](https://lybra-ai.ru)\n\n#Ð˜Ð˜ #Ð¢Ñ€ÐµÐ½Ð´Ñ‹2025 #LybraAI"
          MESSAGE_LENGTH=$(echo -n "$MESSAGE" | wc -c)
          echo "Message length: $MESSAGE_LENGTH"
          if [ "$MESSAGE_LENGTH" -gt 4096 ]; then
            echo "::error::Message length ($MESSAGE_LENGTH) exceeds Telegram limit of 4096 characters"
            exit 1
          fi
          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV
      - name: Log extracted data
        run: |
          echo "TITLE: $TITLE"
          echo "TITLE_ESCAPED: $TITLE_ESCAPED"
          echo "DATE: $DATE"
          echo "SLUG: $SLUG"
          echo "POST_NUM: $POST_NUM"
          echo "TEASER: $TEASER"
          echo "TEASER_ESCAPED: $TEASER_ESCAPED"
          echo "IMAGE_FOUND: $IMAGE_FOUND"
          echo "IMAGE_URL_ACCESSIBLE: $IMAGE_URL_ACCESSIBLE"
          echo "PHOTO_URL: $PHOTO_URL"
          echo "MESSAGE: $MESSAGE"
      - name: Send to Telegram
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdownv2
          message: ${{ env.MESSAGE }}
          photo: ${{ env.PHOTO_URL }}
        env:
          DEBUG: true
      - name: Log Telegram step
        run: |
          echo "TELEGRAM_CHAT_ID: ***"
          echo "Post title: $TITLE_ESCAPED"
          echo "Teaser escaped: $TEASER_ESCAPED"
          echo "URL: https://lybra-ai.ru"
