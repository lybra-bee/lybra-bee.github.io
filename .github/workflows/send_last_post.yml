name: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –≤ Telegram

on:
  workflow_dispatch:

jobs:
  send_post:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Check post files
        run: |
          ls -l _posts/ || echo "No posts directory found"
      - name: Check extract_post_data.py
        run: |
          ls -l extract_post_data.py || echo "extract_post_data.py not found"
      - name: Extract last post data
        run: |
          python extract_post_data.py
      - name: Check image file
        run: |
          IMAGE_PATH="assets/images/posts/post-${{ env.POST_NUM }}.png"
          ls -l $IMAGE_PATH || echo "Image file $IMAGE_PATH not found in repository"
          if [ -f "$IMAGE_PATH" ]; then
            echo "IMAGE_FOUND=true" >> $GITHUB_ENV
          else
            echo "IMAGE_FOUND=false" >> $GITHUB_ENV
          fi
      - name: Check image URL
        run: |
          IMAGE_URL="https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$IMAGE_URL")
          echo "Image URL $IMAGE_URL status: HTTP $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "IMAGE_URL_ACCESSIBLE=true" >> $GITHUB_ENV
          else
            echo "IMAGE_URL_ACCESSIBLE=false" >> $GITHUB_ENV
          fi
      - name: Check default image URL
        run: |
          DEFAULT_IMAGE_URL="https://lybra-ai.ru/assets/images/default.png"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEFAULT_IMAGE_URL")
          echo "Default image URL $DEFAULT_IMAGE_URL status: HTTP $HTTP_STATUS"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "DEFAULT_IMAGE_URL_ACCESSIBLE=true" >> $GITHUB_ENV
          else
            echo "DEFAULT_IMAGE_URL_ACCESSIBLE=false" >> $GITHUB_ENV
          fi
      - name: Fail if no images accessible
        if: env.IMAGE_URL_ACCESSIBLE != 'true' && env.DEFAULT_IMAGE_URL_ACCESSIBLE != 'true'
        run: |
          echo "::error::Neither image https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png nor default image https://lybra-ai.ru/assets/images/default.png is accessible"
          exit 1
      - name: Check post URL
        run: |
          POST_URL="https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$POST_URL")
          echo "Post URL $POST_URL status: HTTP $HTTP_STATUS"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::warning::Post URL $POST_URL not accessible (HTTP $HTTP_STATUS)"
          fi
      - name: Escape title and teaser for Markdown
        run: |
          TITLE="${{ env.TITLE }}"
          TITLE_ESCAPED=$(echo "$TITLE" | sed 's/[ _*[\]()~`>#+-=|{}\.!]/\\&/g')
          echo "TITLE_ESCAPED=$TITLE_ESCAPED" >> $GITHUB_ENV
          TEASER="${{ env.TEASER }}"
          if [ -z "$TEASER" ] || [ "$TEASER" = "–¢–∏–∑–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏." ]; then
            echo "TEASER is empty or default, setting default"
            TEASER="–¢–∏–∑–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏."
          fi
          TEASER=$(echo "$TEASER" | head -c 1000)
          TEASER_ESCAPED=$(echo "$TEASER" | sed 's/[ _*[\]()~`>#+-=|{}\.!]/\\&/g')
          echo "TEASER_ESCAPED=$TEASER_ESCAPED" >> $GITHUB_ENV
          MESSAGE="üì¢ –ù–æ–≤—ã–π –ø–æ—Å—Ç: \"$TITLE_ESCAPED\"\n\n–ö—Ä–∞—Ç–∫–∏–π —Ç–∏–∑–µ—Ä: $TEASER_ESCAPED\n\n[–ß–∏—Ç–∞—Ç—å](https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}?utm_source=telegram&utm_medium=channel&utm_campaign=post)\n\n#–ò–ò #–¢—Ä–µ–Ω–¥—ã2025 #LybraAI"
          MESSAGE_LENGTH=$(echo -n "$MESSAGE" | wc -c)
          echo "Message length: $MESSAGE_LENGTH"
          if [ "$MESSAGE_LENGTH" -gt 4096 ]; then
            echo "::error::Message length ($MESSAGE_LENGTH) exceeds Telegram limit of 4096 characters"
            exit 1
          fi
      - name: Log extracted data
        run: |
          echo "TITLE: ${{ env.TITLE }}"
          echo "TITLE_ESCAPED: ${{ env.TITLE_ESCAPED }}"
          echo "DATE: ${{ env.DATE }}"
          echo "SLUG: ${{ env.SLUG }}"
          echo "POST_NUM: ${{ env.POST_NUM }}"
          echo "TEASER: ${{ env.TEASER }}"
          echo "TEASER_ESCAPED: ${{ env.TEASER_ESCAPED }}"
          echo "IMAGE_FOUND: ${{ env.IMAGE_FOUND }}"
          echo "IMAGE_URL_ACCESSIBLE: ${{ env.IMAGE_URL_ACCESSIBLE }}"
          echo "DEFAULT_IMAGE_URL_ACCESSIBLE: ${{ env.DEFAULT_IMAGE_URL_ACCESSIBLE }}"
      - name: Send to Telegram
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdown
          message: |
            üì¢ –ù–æ–≤—ã–π –ø–æ—Å—Ç: "${{ env.TITLE_ESCAPED }}"

            –ö—Ä–∞—Ç–∫–∏–π —Ç–∏–∑–µ—Ä: ${{ env.TEASER_ESCAPED }}

            [–ß–∏—Ç–∞—Ç—å](https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}?utm_source=telegram&utm_medium=channel&utm_campaign=post)

            #–ò–ò #–¢—Ä–µ–Ω–¥—ã2025 #LybraAI
          photo: |
            ${{ env.IMAGE_URL_ACCESSIBLE == 'true' && format('https://lybra-ai.ru/assets/images/posts/post-{0}.png', env.POST_NUM) || env.DEFAULT_IMAGE_URL_ACCESSIBLE == 'true' && 'https://lybra-ai.ru/assets/images/default.png' || '' }}
      - name: Log Telegram step
        run: |
          echo "TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}"
          echo "Post title: ${{ env.TITLE_ESCAPED }}"
          echo "Teaser escaped: ${{ env.TEASER_ESCAPED }}"
          echo "URL: https://lybra-ai.ru/${{ env.DATE }}/${{ env.SLUG }}"
          echo "Image URL: https://lybra-ai.ru/assets/images/posts/post-${{ env.POST_NUM }}.png"
          echo "Default image URL: https://lybra-ai.ru/assets/images/default.png"
