name: –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –≤ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'  # –ï–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 8:00 UTC (11:00 –ú–°–ö)

env:
  ACTIONS_STEP_DEBUG: true  # –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞

jobs:
  send_post:
    runs-on: ubuntu-latest
    steps:
      - name: üßæ Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: üêç –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml transliterate requests

      - name: üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤
        run: |
          if [ ! -d "_posts" ]; then
            echo "::error::_posts directory missing"
            exit 1
          fi
          ls -l _posts/ || echo "::warning::_posts directory is empty"
          for file in extract_post_data.py escape_markdown.py; do
            if [ ! -f "$file" ]; then
              echo "::error::Missing $file"
              exit 1
            fi
          done

      - name: üß† –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
        run: python extract_post_data.py

      - name: üß© –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        run: |
          if [ -z "$TITLE" ]; then
            echo "::error::TITLE is empty"
            exit 1
          fi
          if [ -z "$DATE" ]; then
            echo "::error::DATE is empty"
            exit 1
          fi
          if [ -z "$SLUG" ]; then
            echo "::error::SLUG is empty"
            exit 1
          fi
          if [ -z "$IMAGE_URL" ]; then
            echo "::error::IMAGE_URL is empty"
            exit 1
          fi
          echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ"

      - name: üñºÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: $IMAGE_URL"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --location --connect-timeout 8 "$IMAGE_URL")
          echo "HTTP —Å—Ç–∞—Ç—É—Å: $STATUS"
          if [ "$STATUS" = "200" ]; then
            echo "PHOTO_URL=$IMAGE_URL" >> $GITHUB_ENV
            echo "IMAGE_OK=true" >> $GITHUB_ENV
          else
            echo "::warning::–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ"
            FALLBACK="https://lybra-ai.ru/assets/images/default.png"
            STATUS2=$(curl -s -o /dev/null -w "%{http_code}" --location "$FALLBACK")
            if [ "$STATUS2" = "200" ]; then
              echo "PHOTO_URL=$FALLBACK" >> $GITHUB_ENV
            else
              echo "::error::–î–∞–∂–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ"
              echo "PHOTO_URL=" >> $GITHUB_ENV
            fi
            echo "IMAGE_OK=false" >> $GITHUB_ENV
          fi

      - name: üß∞ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è Telegram
        run: |
          python escape_markdown.py
          echo "–°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ, –¥–ª–∏–Ω–∞:"
          echo "$MESSAGE" | wc -c

      - name: ü™µ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          echo "TITLE: $TITLE"
          echo "TITLE_ESCAPED: $TITLE_ESCAPED"
          echo "DATE: $DATE"
          echo "SLUG: $SLUG"
          echo "IMAGE_URL: $IMAGE_URL"
          echo "TEASER: $TEASER"
          echo "TEASER_ESCAPED: $TEASER_ESCAPED"
          echo "PHOTO_URL: $PHOTO_URL"
          echo "MESSAGE:"
          echo "$MESSAGE"

      - name: üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—Å—Ç–∞ –≤ Telegram
        uses: appleboy/telegram-action@v1.0.1
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          format: markdownv2
          message: ${{ env.MESSAGE }}
          photo: ${{ env.PHOTO_URL }}
        env:
          DEBUG: true

      - name: üßæ –ò—Ç–æ–≥–æ–≤—ã–π –ª–æ–≥
        run: |
          echo "‚úÖ –ü—É–±–ª–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞."
          echo "üìÖ –î–∞—Ç–∞: $DATE"
          echo "üì∞ –ó–∞–≥–æ–ª–æ–≤–æ–∫: $TITLE"
          echo "üåê –°—Å—ã–ª–∫–∞: https://lybra-ai.ru"
          echo "üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: $PHOTO_URL"
